<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Mapa Conexiones Agua Potable - La Libertad</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2@3.2.3/css/leaflet-sidebar.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        body { margin:0; padding:0; font-family: 'Segoe UI', Arial, sans-serif; background:#f8f9ff; }
        #map { height: 100vh; width: 100%; }
        
        .leaflet-sidebar {
            background: linear-gradient(to bottom, #ffffff 0%, #f0f7ff 100%) !important;
            color: #1a365d !important;
            border-right: 1px solid #bfdbfe;
            box-shadow: 0 0 25px rgba(0,0,0,0.08);
        }
        
        .leaflet-sidebar-tabs ul li a {
            background: #e0f2fe !important;
            color: #0369a1 !important;
        }
        
        .leaflet-sidebar-tabs ul li a:hover,
        .leaflet-sidebar-tabs ul li.active a {
            background: #bae6fd !important;
        }
        
        .leaflet-sidebar-header {
            background: #1d4ed8;
            color: white;
            padding: 20px;
            font-size: 20px;
            font-weight: 600;
            border-bottom: 4px solid #3b82f6;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .leaflet-sidebar-content {
            padding: 24px 20px;
        }
        
        h4 {
            color: #1d4ed8;
            font-size: 18px;
            margin: 0 0 20px 0;
            text-align: center;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid #bfdbfe;
        }
        
        button {
            width: 100%;
            height: 54px;
            font-size: 15px;
            font-weight: 600;
            margin: 10px 0;
            padding: 0 16px;
            border-radius: 8px;
            border: none;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            transition: all 0.25s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(59,130,246,0.25);
        }
        
        button:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59,130,246,0.35);
        }
        
        button[onclick="imprimirMapaNormal()"] {
            background: #16a34a !important;
        }
        
        button[onclick="imprimirMapaNormal()"]:hover {
            background: #15803d !important;
        }
        
        #export-buttons button {
            background: #64748b;
            height: 50px;
        }
        
        select, input[type="text"], input[type="file"] {
            width: 100%;
            padding: 14px 16px;
            font-size: 15px;
            border: 1px solid #93c5fd;
            border-radius: 8px;
            margin: 10px 0;
            background: white;
        }
        
        select:focus, input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
        }
        
        #leyenda {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 14px 18px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            font-size: 13px;
            border: 1px solid #e5e7eb;
            z-index: 1000;
        }
        
        .leyenda-item { display: flex; align-items: center; margin: 6px 0; }
        .leyenda-color { width: 16px; height: 16px; border-radius: 50%; margin-right: 10px; border: 1px solid #666; }
        
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            justify-content: center; align-items: center;
        }
        
        .modal-content {
            background: white;
            color: #1f2937;
            padding: 24px;
            border-radius: 12px;
            width: 380px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        }
        
        .close { float: right; font-size: 28px; cursor: pointer; color: #666; }

        /* Estilo para botón de ubicación activo */
        .location-control-active {
            background-color: #a5d8ff !important;
        }
        
        .location-control-active i {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.25); }
            100% { transform: scale(1); }
        }

        @media print {
            #leyenda, .leaflet-control-container, .leaflet-sidebar { display: none !important; }
            #map { height: 100vh !important; }
            body::before {
                content: "Mapa de Conexiones de Agua Potable - Región La Libertad";
                display: block; text-align: center; font-size: 26px; font-weight: bold;
                color: #1d4ed8; margin: 30px 0 20px;
            }
        }
    </style>
</head>
<body data-print-date="">

    <div id="map"></div>

    <!-- Sidebar -->
    <div id="sidebar" class="leaflet-sidebar collapsed">
        <div class="leaflet-sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
            </ul>
        </div>

        <div class="leaflet-sidebar-content">
            <div class="leaflet-sidebar-pane active" id="home">
                <h1 class="leaflet-sidebar-header">
                    <i class="fa fa-tint"></i> Conexiones Agua Potable
                    <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                
                <h4>Gestión de Puntos</h4>
                
                <input type="file" id="excelFile" accept=".xlsx" multiple />
                
                <select id="distritoFilter">
                    <option value="">Selecciona distrito</option>
                </select>
                
                <button onclick="verConteo()"><i class="fa fa-chart-pie"></i> Ver Conteo General</button>
                <button onclick="verReportePorLocalidad()"><i class="fa fa-table"></i> Reporte por Localidad</button>
                <button onclick="abrirFiltroVisibilidad()"><i class="fa fa-filter"></i> Filtrar Visibilidad</button>
                <button onclick="abrirArchivosModal()"><i class="fa fa-folder"></i> Gestionar Archivos</button>
                <button id="btnSeleccionar" onclick="toggleModoClic()"><i class="fa fa-hand-pointer"></i> SELECCIONAR PUNTOS</button>
                <button onclick="limpiarSeleccion()"><i class="fa fa-eraser"></i> Limpiar Selección</button>
                <button onclick="limpiarMapa()"><i class="fa fa-trash-can"></i> Limpiar Mapa</button>
                
                <button onclick="imprimirMapaNormal()">
                    <i class="fa fa-print"></i> IMPRIMIR MAPA
                </button>
                
                <hr style="border-color:#bfdbfe; margin:20px 0;">
                
                <input type="text" id="search-box" placeholder="Buscar ID / Dir / Medidor">
                
                <hr style="border-color:#bfdbfe; margin:20px 0;">
                
                <div id="export-buttons">
                    <button onclick="exportarSeleccionPDF()"><i class="fa fa-file-pdf"></i> PDF</button>
                    <button onclick="exportarSeleccionExcel()"><i class="fa fa-file-excel"></i> EXCEL</button>
                </div>
                <small style="color:#64748b; display:block; text-align:center; margin-top:10px;">
                    Exporta la selección actual
                </small>
            </div>
        </div>
    </div>

    <!-- Leyenda -->
    <div id="leyenda">
        <strong>Leyenda</strong><br>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#d32f2f;"></div>A1</div>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#ffeb3b;"></div>A2</div>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#4caf50;"></div>A3</div>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#212121;"></div>Imposibilidad</div>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#4682b4;"></div>Proyecto Total</div>
    </div>

    <!-- Modales -->
    <div id="conteoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('conteoModal')">×</span>
            <h4>Conteo General</h4>
            <div>A1: <span id="modalCountA1">0</span></div>
            <div>A2: <span id="modalCountA2">0</span></div>
            <div>A3: <span id="modalCountA3">0</span></div>
            <div>Imposibilidad: <span id="modalCountIMP">0</span></div>
            <div>Proyecto Total: <span id="modalCountPROY">0</span></div>
            <hr>
            <div>Total cargados: <span id="modalCountTotal">0</span></div>
            <div>Selección actual: <span id="modalSelectionCount">0</span> puntos</div>
        </div>
    </div>

    <div id="reporteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('reporteModal')">×</span>
            <h4>Reporte por Localidad</h4>
            <div id="reporteContenido">Carga un archivo para ver el reporte.</div>
            <button onclick="exportarReporteLocalidadExcel()" style="margin-top:15px; background:#f59e0b; color:white; display:none;" id="btnExportReporte">
                Exportar a Excel
            </button>
        </div>
    </div>

    <div id="filtroModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('filtroModal')">×</span>
            <h4>Filtrar Visibilidad</h4>
            <div style="text-align: left; margin: 15px 0;">
                <label><input type="checkbox" id="visA1" checked> A1 (Rojo)</label><br>
                <label><input type="checkbox" id="visA2" checked> A2 (Amarillo)</label><br>
                <label><input type="checkbox" id="visA3" checked> A3 (Verde)</label><br>
                <label><input type="checkbox" id="visIMP" checked> Imposibilidad (Negro)</label><br>
                <label><input type="checkbox" id="visProyecto" checked> Proyecto Total (Azul)</label>
            </div>
            <button onclick="aplicarFiltroVisibilidad()" style="margin-top:20px; background:#1d4ed8; color:white; padding:12px; width:100%;">
                Aplicar
            </button>
        </div>
    </div>

    <div id="filesModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('filesModal')">×</span>
            <h4>Archivos Cargados</h4>
            <div id="filesList" style="text-align: left; margin: 15px 0;"></div>
            <button onclick="aplicarVisibilidadArchivos()" style="margin-top:20px; background:#1d4ed8; color:white; padding:12px; width:100%;">
                Aplicar
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-sidebar-v2@3.2.3/js/leaflet-sidebar.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js"></script>

    <script>
        const { jsPDF } = window.jspdf;

        var map = L.map('map').setView([-7.8, -78.5], 9);

        var baseLayers = {
            "Calles": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }),
            "Satélite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' })
        };
        baseLayers["Calles"].addTo(map);
        L.control.layers(baseLayers, null, {position: 'topright'}).addTo(map);

        var loadedFiles = [];
        var selectedMarkers = [];
        var modoClic = false;
        var reporteData = [];
        var locationWatcher = null;
        var locationMarker = null;
        var locationAccuracyCircle = null;
        var isLocationActive = false;

        var visibilidad = {
            A1: true,
            A2: true,
            A3: true,
            IMPOSIBILIDAD: true,
            PROYECTO: true
        };

        var sidebar = L.control.sidebar({
            container: 'sidebar',
            position: 'left',
            closeButton: true,
            autopan: false
        }).addTo(map);

        // Control flotante de ubicación
        L.Control.UbicacionButton = L.Control.extend({
            options: { position: 'topright' },

            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                this.button = L.DomUtil.create('a', '', container);
                
                this.button.href = '#';
                this.button.title = 'Mi ubicación en tiempo real';
                this.button.innerHTML = '<i class="fa fa-location-arrow" style="font-size:18px; line-height:26px;"></i>';
                this.button.style.width = '34px';
                this.button.style.height = '34px';
                this.button.style.display = 'block';
                this.button.style.textAlign = 'center';
                this.button.style.backgroundColor = '#ffffff';
                this.button.style.borderBottom = '1px solid #ccc';

                L.DomEvent
                    .on(this.button, 'mousedown', L.DomEvent.stopPropagation)
                    .on(this.button, 'click', L.DomEvent.preventDefault)
                    .on(this.button, 'click', () => {
                        toggleLocation();
                        this.updateActiveState();
                    });

                this.updateActiveState();
                return container;
            },

            updateActiveState: function() {
                if (isLocationActive) {
                    this.button.parentElement.classList.add('location-control-active');
                } else {
                    this.button.parentElement.classList.remove('location-control-active');
                }
            }
        });

        const ubicacionControl = new L.Control.UbicacionButton();
        ubicacionControl.addTo(map);

        function getColor(tipo) {
            switch(tipo) {
                case 'A1': return '#d32f2f';
                case 'A2': return '#ffeb3b';
                case 'A3': return '#4caf50';
                case 'IMPOSIBILIDAD': return '#212121';
                case 'PROYECTO': return '#4682b4';
                default: return '#888888';
            }
        }

        function crearMarcador(lat, lng, color) {
            return L.circleMarker([lat, lng], {
                radius: 6,
                fillColor: color,
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.85
            });
        }

        document.getElementById('excelFile').addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length === 0) return;
            Array.from(files).forEach(file => {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, {type: 'array'});
                    var sheet = workbook.Sheets[workbook.SheetNames[0]];
                    var json = XLSX.utils.sheet_to_json(sheet);
                    procesarDatos(file.name, json);
                };
                reader.readAsArrayBuffer(file);
            });
            e.target.value = '';
        });

        function procesarDatos(filename, data) {
            const fileEntry = {
                filename,
                data,
                markers: [],
                clusterGroup: L.markerClusterGroup({
                    chunkedLoading: true,
                    disableClusteringAtZoom: 16,
                    maxClusterRadius: 50
                }),
                individualLayer: L.layerGroup(),
                visible: true
            };

            data.forEach(row => {
                if (row.LATITUD && row.LONGITUD) {
                    const actividadRaw = (row.ACTIVIDAD || '').toString().trim().toUpperCase();
                    let tipo = 'PROYECTO';
                    if (actividadRaw === 'A1') tipo = 'A1';
                    else if (actividadRaw === 'A2') tipo = 'A2';
                    else if (actividadRaw === 'A3') tipo = 'A3';
                    else if (actividadRaw === 'IMPOSIBILIDAD') tipo = 'IMPOSIBILIDAD';

                    const color = getColor(tipo);
                    var marker = crearMarcador(row.LATITUD, row.LONGITUD, color);
                    marker.properties = {...row, tipoFiltro: tipo, color: color, filename: filename};

                    const medidorText = row.MEDIDOR ? row.MEDIDOR : 'SIN MEDIDOR';

                    marker.bindPopup(
                        `<strong>ID:</strong> ${row.ID || 'N/D'}<br>` +
                        `<strong>Medidor:</strong> ${medidorText}<br>` +
                        `<strong>Actividad:</strong> ${row.ACTIVIDAD || 'SIN DATO'}<br>` +
                        `<strong>Tipo:</strong> ${tipo}<br>` +
                        `<strong>Dirección:</strong> ${row.DIRECCION || ''}<br>` +
                        `<strong>Distrito:</strong> ${row.DISTRITO || ''}<br>` +
                        `<strong>Coordenadas:</strong> ${row.LATITUD}, ${row.LONGITUD}<br>` +
                        `<strong>Archivo:</strong> ${filename}`
                    );

                    marker.on('click', function(e) {
                        if (modoClic) toggleSeleccionMarker(this);
                        else map.openPopup(this.getPopup());
                    });

                    fileEntry.markers.push(marker);
                    fileEntry.clusterGroup.addLayer(marker);
                    fileEntry.individualLayer.addLayer(marker);
                }
            });

            loadedFiles.push(fileEntry);
            actualizarDistritos();
            aplicarFiltros();
            alert(`¡Listo! Cargados ${fileEntry.markers.length} puntos del archivo ${filename}.`);
        }

        function actualizarDistritos() {
            const allDistritos = new Set();
            loadedFiles.forEach(file => {
                file.data.forEach(row => {
                    if (row.DISTRITO) allDistritos.add(row.DISTRITO);
                });
            });
            const distritos = [...allDistritos].sort();
            const selectDist = document.getElementById('distritoFilter');
            selectDist.innerHTML = '<option value="">Selecciona distrito</option><option value="TODOS">TODOS DISTRITOS</option>';
            distritos.forEach(d => {
                let opt = document.createElement('option');
                opt.value = d; opt.text = d;
                selectDist.appendChild(opt);
            });
        }

        function aplicarFiltros() {
            loadedFiles.forEach(file => {
                if (map.hasLayer(file.clusterGroup)) map.removeLayer(file.clusterGroup);
                if (map.hasLayer(file.individualLayer)) map.removeLayer(file.individualLayer);
                file.clusterGroup.clearLayers();
                file.individualLayer.clearLayers();
            });

            const distrito = document.getElementById('distritoFilter').value;

            loadedFiles.forEach(file => {
                if (!file.visible) return;

                file.markers.forEach(m => {
                    if (distrito !== '' && distrito !== 'TODOS' && m.properties.DISTRITO !== distrito) return;
                    if (!visibilidad[m.properties.tipoFiltro]) return;

                    const marker = crearMarcador(m.getLatLng().lat, m.getLatLng().lng, m.properties.color);
                    marker.properties = m.properties;
                    marker.bindPopup(m._popup._content);
                    marker.on('click', e => modoClic ? toggleSeleccionMarker(marker) : map.openPopup(marker.getPopup()));

                    file.clusterGroup.addLayer(marker);
                    file.individualLayer.addLayer(marker);
                });

                selectedMarkers.forEach(p => {
                    if (p.filename !== file.filename) return;
                    const marker = crearMarcador(p.LATITUD, p.LONGITUD, '#00ff00');
                    marker.properties = p;
                    marker.setStyle({radius: 9});
                    marker.on('click', () => modoClic && toggleSeleccionMarker(marker));
                    file.individualLayer.addLayer(marker);
                });
            });

            controlarVistaPorZoom();
        }

        function controlarVistaPorZoom() {
            const zoom = map.getZoom();
            loadedFiles.forEach(file => {
                if (!file.visible) return;
                if (zoom >= 16) {
                    map.removeLayer(file.clusterGroup);
                    map.addLayer(file.individualLayer);
                } else {
                    map.removeLayer(file.individualLayer);
                    map.addLayer(file.clusterGroup);
                }
            });
        }

        function toggleModoClic() {
            modoClic = !modoClic;
            map.getContainer().style.cursor = modoClic ? 'crosshair' : 'grab';
            document.getElementById('btnSeleccionar').classList.toggle('active', modoClic);
            if (modoClic) alert("Modo selección activado. Haz clic en los puntos para seleccionarlos.");
            aplicarFiltros();
        }

        function toggleSeleccionMarker(marker) {
            const props = marker.properties;
            const key = props.ID ? props.ID : `${props.LATITUD}_${props.LONGITUD}`;
            const index = selectedMarkers.findIndex(s => (s.ID ? s.ID : `${s.LATITUD}_${s.LONGITUD}`) === key);
            if (index === -1) {
                selectedMarkers.push(props);
                marker.setStyle({fillColor: '#00ff00', radius: 9});
            } else {
                selectedMarkers.splice(index, 1);
                marker.setStyle({fillColor: props.color, radius: 6});
            }
            actualizarConteos();
        }

        function limpiarSeleccion() {
            selectedMarkers = [];
            aplicarFiltros();
            actualizarConteos();
        }

        function limpiarMapa() {
            loadedFiles = [];
            selectedMarkers = [];
            actualizarDistritos();
            aplicarFiltros();
        }

        function toggleLocation() {
            isLocationActive = !isLocationActive;
            
            ubicacionControl.updateActiveState();

            if (isLocationActive) {
                if (!navigator.geolocation) {
                    alert('La geolocalización no está disponible en este navegador.');
                    isLocationActive = false;
                    ubicacionControl.updateActiveState();
                    return;
                }
                locationWatcher = navigator.geolocation.watchPosition(updateLocation, handleLocationError, {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 5000
                });
            } else {
                if (locationWatcher) navigator.geolocation.clearWatch(locationWatcher);
                if (locationMarker) map.removeLayer(locationMarker);
                if (locationAccuracyCircle) map.removeLayer(locationAccuracyCircle);
                locationMarker = null;
                locationAccuracyCircle = null;
            }
        }

        function updateLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            if (!locationMarker) {
                locationMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'location-marker',
                        html: '<div style="background: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map).bindPopup('Tu ubicación actual');
            } else {
                locationMarker.setLatLng([lat, lng]);
            }

            if (!locationAccuracyCircle) {
                locationAccuracyCircle = L.circle([lat, lng], {
                    radius: accuracy,
                    color: '#3b82f6',
                    fillColor: '#93c5fd',
                    fillOpacity: 0.2
                }).addTo(map);
            } else {
                locationAccuracyCircle.setLatLng([lat, lng]);
                locationAccuracyCircle.setRadius(accuracy);
            }
        }

        function handleLocationError(error) {
            let mensaje = 'Error al obtener ubicación: ';
            switch(error.code) {
                case error.PERMISSION_DENIED: mensaje += 'Permiso denegado'; break;
                case error.POSITION_UNAVAILABLE: mensaje += 'Información no disponible'; break;
                case error.TIMEOUT: mensaje += 'Tiempo de espera agotado'; break;
                default: mensaje += error.message;
            }
            alert(mensaje);
            isLocationActive = false;
            ubicacionControl.updateActiveState();
        }

        function actualizarConteos() {
            const markers = getAllVisibleMarkers();
            const c = { A1:0, A2:0, A3:0, IMPOSIBILIDAD:0, PROYECTO:0, total: markers.length };
            markers.forEach(m => {
                if (c.hasOwnProperty(m.properties.tipoFiltro)) c[m.properties.tipoFiltro]++;
            });
            document.getElementById('modalCountA1').textContent = c.A1;
            document.getElementById('modalCountA2').textContent = c.A2;
            document.getElementById('modalCountA3').textContent = c.A3;
            document.getElementById('modalCountIMP').textContent = c.IMPOSIBILIDAD;
            document.getElementById('modalCountPROY').textContent = c.PROYECTO;
            document.getElementById('modalCountTotal').textContent = c.total;
            document.getElementById('modalSelectionCount').textContent = selectedMarkers.length;
        }

        function verConteo() {
            actualizarConteos();
            document.getElementById('conteoModal').style.display = 'flex';
        }

        function cerrarModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) event.target.style.display = 'none';
        };

        map.on('zoomend', controlarVistaPorZoom);
        document.getElementById('distritoFilter').addEventListener('change', aplicarFiltros);

                document.getElementById('search-box').addEventListener('input', function() {
            const term = this.value.trim().toLowerCase();
            
            if (!term) {
                aplicarFiltros();
                return;
            }

            loadedFiles.forEach(file => {
                // Limpiamos las capas actuales
                if (map.hasLayer(file.clusterGroup)) map.removeLayer(file.clusterGroup);
                if (map.hasLayer(file.individualLayer)) map.removeLayer(file.individualLayer);
                file.clusterGroup.clearLayers();
                file.individualLayer.clearLayers();

                const distritoSeleccionado = document.getElementById('distritoFilter').value;

                const resultados = file.markers.filter(m => {
                    // Filtro por distrito si está seleccionado
                    if (distritoSeleccionado && distritoSeleccionado !== 'TODOS' && 
                        m.properties.DISTRITO !== distritoSeleccionado) {
                        return false;
                    }

                    // Filtro por visibilidad de tipo
                    if (!visibilidad[m.properties.tipoFiltro]) return false;

                    // Búsqueda en los campos principales
                    return (
                        (m.properties.ID && m.properties.ID.toString().toLowerCase().includes(term)) ||
                        (m.properties.DIRECCION && m.properties.DIRECCION.toLowerCase().includes(term)) ||
                        (m.properties.MEDIDOR && m.properties.MEDIDOR.toString().toLowerCase().includes(term))
                    );
                });

                // Volvemos a crear los marcadores encontrados
                resultados.forEach(m => {
                    const marker = crearMarcador(
                        m.getLatLng().lat,
                        m.getLatLng().lng,
                        m.properties.color
                    );
                    
                    marker.properties = m.properties;
                    marker.bindPopup(m._popup._content);
                    
                    marker.on('click', function(e) {
                        if (modoClic) {
                            toggleSeleccionMarker(this);
                        } else {
                            map.openPopup(this.getPopup());
                        }
                    });

                    file.clusterGroup.addLayer(marker);
                    file.individualLayer.addLayer(marker);
                });
            });

            // Actualizamos la vista según el nivel de zoom
            controlarVistaPorZoom();
        });

        // Limpieza automática al cerrar la pestaña/ventana
        window.addEventListener('beforeunload', () => {
            if (locationWatcher) {
                navigator.geolocation.clearWatch(locationWatcher);
            }
        });

        // ==============================================
        //   Funciones complementarias necesarias
        // ==============================================

        function getAllVisibleMarkers() {
            let markers = [];
            loadedFiles.forEach(file => {
                if (file.visible) {
                    markers = markers.concat(file.markers);
                }
            });
            return markers;
        }

        function actualizarConteos() {
            const markers = getAllVisibleMarkers();
            const conteo = {
                A1: 0,
                A2: 0,
                A3: 0,
                IMPOSIBILIDAD: 0,
                PROYECTO: 0,
                total: markers.length
            };

            markers.forEach(m => {
                if (conteo.hasOwnProperty(m.properties.tipoFiltro)) {
                    conteo[m.properties.tipoFiltro]++;
                }
            });

            document.getElementById('modalCountA1').textContent = conteo.A1;
            document.getElementById('modalCountA2').textContent = conteo.A2;
            document.getElementById('modalCountA3').textContent = conteo.A3;
            document.getElementById('modalCountIMP').textContent = conteo.IMPOSIBILIDAD;
            document.getElementById('modalCountPROY').textContent = conteo.PROYECTO;
            document.getElementById('modalCountTotal').textContent = conteo.total;
            document.getElementById('modalSelectionCount').textContent = selectedMarkers.length;
        }

        function verConteo() {
            actualizarConteos();
            document.getElementById('conteoModal').style.display = 'flex';
        }

        function cerrarModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        // Inicialización final de eventos
        map.on('zoomend', controlarVistaPorZoom);

    </script>
</body>
</html>
