<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Conexiones Agua Potable - La Libertad</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2@3.2.3/css/leaflet-sidebar.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        body { margin:0; padding:0; font-family: 'Segoe UI', Arial, sans-serif; background:#f8f9ff; }
        #map { height: 100vh; width: 100%; }
        
        .leaflet-sidebar {
            background: linear-gradient(to bottom, #ffffff 0%, #f0f7ff 100%) !important;
            color: #1a365d !important;
            border-right: 1px solid #bfdbfe;
            box-shadow: 0 0 25px rgba(0,0,0,0.08);
        }
        
        .leaflet-sidebar-tabs ul li a {
            background: #e0f2fe !important;
            color: #0369a1 !important;
        }
        
        .leaflet-sidebar-tabs ul li a:hover,
        .leaflet-sidebar-tabs ul li.active a {
            background: #bae6fd !important;
        }
        
        .leaflet-sidebar-header {
            background: #1d4ed8;
            color: white;
            padding: 1px;
            font-size: 20px;
            font-weight: 600;
            border-bottom: 1px solid #3b82f6;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .leaflet-sidebar-content {
            padding: 24px 0px;
        }
        
        h4 {
            color: #1d4ed8;
            font-size: 22px;
            margin: 0 0 20px 0;
            text-align: center;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid #bfdbfe;
        }
        
        button {
            width: 100%;
            height: 30px;
            font-size: 15px;
            font-weight: 600;
            margin: 10px 0;
            padding: 0 16px;
            border-radius: 8px;
            border: none;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            transition: all 0.25s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(59,130,246,0.25);
        }
        
        button:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59,130,246,0.35);
        }
        
        button[onclick="imprimirMapaNormal()"] {
            background: #16a34a !important;
            font-size: 16px;
        }
        
        button[onclick="imprimirMapaNormal()"]:hover {
            background: #15803d !important;
        }


        #export-buttons button {
            background: #64748b;
            height: 30px;
        }
        
        #export-buttons button:hover {
            background: #475569;
        }

        select, input[type="text"], input[type="file"] {
            width: 100%;
            padding: 14px 16px;
            font-size: 15px;
            border: 1px solid #93c5fd;
            border-radius: 8px;
            margin: 10px 0;
            background: white;
        }
        
        select:focus, input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
        }
        

        #leyenda {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 14px 18px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            font-size: 13px;
            border: 1px solid #e5e7eb;
            z-index: 1000;
        }
        
        .leyenda-item { display: flex; align-items: center; margin: 6px 0; }
        .leyenda-color { width: 16px; height: 16px; border-radius: 50%; margin-right: 10px; border: 1px solid #666; }
        
        .legend-toggle {
            position: absolute;
            bottom: 100px;
            right: 30px;
            z-index: 1001;
            background: white;
            border: 2px solid #4682b4;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.25);
            font-size: 18px;
            color: #4682b4;
            transition: all 0.25s;
        }
        
        .legend-toggle:hover {
            background: #4682b4;
            color: white;
            transform: scale(1.08);
            box-shadow: 0 5px 15px rgba(70,130,180,0.4);
        }
        
        #leyenda.hidden { display: none !important; }
        
        .location-control-active { background-color: #a5d8ff !important; }
        .location-control-active i { animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.25); }
            100% { transform: scale(1); }
        }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background: white; color: #1f2937; padding: 24px; border-radius: 12px; width: 380px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
        .close { float: right; font-size: 28px; cursor: pointer; color: #666; }

        @media print {
            #leyenda, .leaflet-control-container, .leaflet-sidebar, .legend-toggle { display: none !important; }
            #map { height: 100vh !important; }
            body::before { content: "Mapa de Conexiones de Agua Potable - Región La Libertad"; display: block; text-align: center; font-size: 26px; font-weight: bold; color: #1d4ed8; margin: 30px 0 20px; }
        }
    </style>
</head>
<body data-print-date="">
    <div id="map"></div>

    <!-- Sidebar -->
    <div id="sidebar" class="leaflet-sidebar collapsed">
        <div class="leaflet-sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
            </ul>
        </div>

        <div class="leaflet-sidebar-content">
            <div class="leaflet-sidebar-pane active" id="home">
                <h1 class="leaflet-sidebar-header">
                    <i class="fa fa-tint"></i> Conexiones Agua Potable
                    <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                
                <h4></h4>
                
                <input type="file" id="excelFile" accept=".xlsx" multiple />
                
                <select id="distritoFilter">
                    <option value="">Selecciona distrito</option>
                </select>
                
                <button onclick="verConteo()"><i class="fa fa-chart-pie"></i> Ver Conteo General</button>
                <button onclick="verReportePorLocalidad()"><i class="fa fa-table"></i> Reporte por Localidad</button>
                <button onclick="abrirFiltroVisibilidad()"><i class="fa fa-filter"></i> Filtrar Visibilidad</button>
                <button onclick="abrirArchivosModal()"><i class="fa fa-folder"></i> Gestionar Archivos</button>
                <button id="btnSeleccionar" onclick="toggleModoClic()"><i class="fa fa-hand-pointer"></i> SELECCIONAR PUNTOS</button>
                <button onclick="limpiarSeleccion()"><i class="fa fa-eraser"></i> Limpiar Selección</button>
                <button onclick="limpiarMapa()"><i class="fa fa-trash-can"></i> Limpiar Mapa</button>
                
                <button onclick="imprimirMapaNormal()">
                    <i class="fa fa-print"></i> IMPRIMIR MAPA
                </button>
                
                <hr style="border-color:#bfdbfe; margin:20px 0;">
                
                <input type="text" id="search-box" placeholder="Buscar ID / Dir / Medidor">
                
                <hr style="border-color:#bfdbfe; margin:20px 0;">
                
                <div id="export-buttons">
                    <button onclick="exportarSeleccionPDF()"><i class="fa fa-file-pdf"></i> PDF</button>
                    <button onclick="exportarSeleccionExcel()"><i class="fa fa-file-excel"></i> EXCEL</button>
                </div>
                <small style="color:#64748b; display:block; text-align:center; margin-top:10px;">
                    Exporta la selección actual
                </small>
            </div>
        </div>
    </div>

    <!-- Leyenda (inicia oculta) + botón toggle flotante -->
    <div id="leyenda" class="hidden">
        <strong>Leyenda</strong><br>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#d32f2f;"></div>A1</div>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#ffeb3b;"></div>A2</div>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#4caf50;"></div>A3</div>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#212121;"></div>Imposibilidad</div>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#4682b4;"></div>Proyecto Total</div>
    </div>

    <div class="legend-toggle" id="toggleLeyenda" title="Mostrar/Ocultar leyenda">
        <i class="fa fa-eye"></i>
    </div>

    <!-- Modales -->
    <div id="conteoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('conteoModal')">×</span>
            <h4>Conteo General</h4>
            <div>A1: <span id="modalCountA1">0</span></div>
            <div>A2: <span id="modalCountA2">0</span></div>
            <div>A3: <span id="modalCountA3">0</span></div>
            <div>Imposibilidad: <span id="modalCountIMP">0</span></div>
            <div>Proyecto Total: <span id="modalCountPROY">0</span></div>
            <hr>
            <div>Total cargados: <span id="modalCountTotal">0</span></div>
            <div>Selección actual: <span id="modalSelectionCount">0</span> puntos</div>
        </div>
    </div>

    <div id="reporteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('reporteModal')">×</span>
            <h4>Reporte por Localidad</h4>
            <div id="reporteContenido">Carga un archivo para ver el reporte.</div>
            <button onclick="exportarReporteLocalidadExcel()" style="margin-top:15px; background:#f59e0b; color:white; display:none;" id="btnExportReporte">
                Exportar a Excel
            </button>
        </div>
    </div>

    <div id="filtroModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('filtroModal')">×</span>
            <h4>Filtrar Visibilidad</h4>
            <div style="text-align: left; margin: 15px 0;">
                <label><input type="checkbox" id="visA1" checked> A1 (Rojo)</label><br>
                <label><input type="checkbox" id="visA2" checked> A2 (Amarillo)</label><br>
                <label><input type="checkbox" id="visA3" checked> A3 (Verde)</label><br>
                <label><input type="checkbox" id="visIMP" checked> Imposibilidad (Negro)</label><br>
                <label><input type="checkbox" id="visProyecto" checked> Proyecto Total (Azul)</label>
            </div>
            <button onclick="aplicarFiltroVisibilidad()" style="margin-top:20px; background:#1d4ed8; color:white; padding:12px; width:100%;">
                Aplicar
            </button>
        </div>
    </div>

    <div id="filesModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('filesModal')">×</span>
            <h4>Archivos Cargados</h4>
            <div id="filesList" style="text-align: left; margin: 15px 0;"></div>
            <button onclick="aplicarVisibilidadArchivos()" style="margin-top:20px; background:#1d4ed8; color:white; padding:12px; width:100%;">
                Aplicar
            </button>
        </div>
    </div>
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-sidebar-v2@3.2.3/js/leaflet-sidebar.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js"></script>

    <script>
        const { jsPDF } = window.jspdf;

        var map = L.map('map').setView([-7.8, -78.5], 9);

        var baseLayers = {
            "Calles": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }),
            "Satélite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' })
        };
        baseLayers["Calles"].addTo(map);
        L.control.layers(baseLayers, null, {position: 'topright'}).addTo(map);

        var loadedFiles = [];
        var selectedMarkers = [];
        var modoClic = false;
        var reporteData = [];
        var locationWatcher = null;
        var locationMarker = null;
        var locationAccuracyCircle = null;
        var isLocationActive = false;
        var firstLocationReceived = false;

        var visibilidad = {
            A1: true,
            A2: true,
            A3: true,
            IMPOSIBILIDAD: true,
            PROYECTO: true
        };

        var sidebar = L.control.sidebar({
            container: 'sidebar',
            position: 'left',
            closeButton: true,
            autopan: false
        }).addTo(map);

        function getColor(tipo) {
            switch(tipo) {
                case 'A1': return '#d32f2f';
                case 'A2': return '#ffeb3b';
                case 'A3': return '#4caf50';
                case 'IMPOSIBILIDAD': return '#212121';
                case 'PROYECTO': return '#4682b4';
                default: return '#888888';
            }
        }

        function crearMarcador(lat, lng, color) {
            return L.circleMarker([lat, lng], {
                radius: 6,
                fillColor: color,
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.85
            });
        }

        // Control flotante de ubicación (mejora)
        L.Control.UbicacionButton = L.Control.extend({
            options: { position: 'topright' },

            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                this.button = L.DomUtil.create('a', '', container);
                
                this.button.href = '#';
                this.button.title = 'Mi ubicación en tiempo real';
                this.button.innerHTML = '<i class="fa fa-location-arrow" style="font-size:18px; line-height:26px;"></i>';
                this.button.style.width = '34px';
                this.button.style.height = '34px';
                this.button.style.display = 'block';
                this.button.style.textAlign = 'center';
                this.button.style.backgroundColor = '#ffffff';
                this.button.style.borderBottom = '1px solid #ccc';

                L.DomEvent
                    .on(this.button, 'mousedown', L.DomEvent.stopPropagation)
                    .on(this.button, 'click', L.DomEvent.preventDefault)
                    .on(this.button, 'click', () => {
                        toggleLocation();
                        this.updateActiveState();
                    });

                this.updateActiveState();
                return container;
            },

            updateActiveState: function() {
                if (isLocationActive) {
                    this.button.parentElement.classList.add('location-control-active');
                } else {
                    this.button.parentElement.classList.remove('location-control-active');
                }
            }
        });

        const ubicacionControl = new L.Control.UbicacionButton();
        ubicacionControl.addTo(map);

        // Toggle leyenda
        document.getElementById('toggleLeyenda').addEventListener('click', function() {
            const leyenda = document.getElementById('leyenda');
            const icon = this.querySelector('i');
            
            if (leyenda.classList.contains('hidden')) {
                leyenda.classList.remove('hidden');
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
                this.title = "Ocultar leyenda";
            } else {
                leyenda.classList.add('hidden');
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
                this.title = "Mostrar leyenda";
            }
        });
        // Carga de Excel
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length === 0) return;
            Array.from(files).forEach(file => {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, {type: 'array'});
                    var sheet = workbook.Sheets[workbook.SheetNames[0]];
                    var json = XLSX.utils.sheet_to_json(sheet);
                    procesarDatos(file.name, json);
                };
                reader.readAsArrayBuffer(file);
            });
            e.target.value = '';
        });

        function procesarDatos(filename, data) {
            const fileEntry = {
                filename,
                data,
                markers: [],
                clusterGroup: L.markerClusterGroup({
                    chunkedLoading: true,
                    disableClusteringAtZoom: 16,
                    maxClusterRadius: 50
                }),
                individualLayer: L.layerGroup(),
                visible: true
            };

            data.forEach(row => {
                if (row.LATITUD && row.LONGITUD) {
                    const actividadRaw = (row.ACTIVIDAD || '').toString().trim().toUpperCase();
                    let tipo = 'PROYECTO';
                    if (actividadRaw === 'A1') tipo = 'A1';
                    else if (actividadRaw === 'A2') tipo = 'A2';
                    else if (actividadRaw === 'A3') tipo = 'A3';
                    else if (actividadRaw === 'IMPOSIBILIDAD') tipo = 'IMPOSIBILIDAD';

                    const color = getColor(tipo);
                    var marker = crearMarcador(row.LATITUD, row.LONGITUD, color);
                    marker.properties = {...row, tipoFiltro: tipo, color: color, filename: filename};

                    const medidorText = row.MEDIDOR ? row.MEDIDOR : 'SIN MEDIDOR';

                    marker.bindPopup(
                        `<strong>ID:</strong> ${row.ID || 'N/D'}<br>` +
                        `<strong>Medidor:</strong> ${medidorText}<br>` +
                        `<strong>Actividad:</strong> ${row.ACTIVIDAD || 'SIN DATO'}<br>` +
                        `<strong>Tipo:</strong> ${tipo}<br>` +
                        `<strong>Dirección:</strong> ${row.DIRECCION || ''}<br>` +
                        `<strong>Distrito:</strong> ${row.DISTRITO || ''}<br>` +
                        `<strong>Coordenadas:</strong> ${row.LATITUD}, ${row.LONGITUD}<br>` +
                        `<strong>Archivo:</strong> ${filename}`
                    );

                    marker.on('click', function(e) {
                        if (modoClic) toggleSeleccionMarker(this);
                        else map.openPopup(this.getPopup());
                    });

                    fileEntry.markers.push(marker);
                    fileEntry.clusterGroup.addLayer(marker);
                    fileEntry.individualLayer.addLayer(marker);
                }
            });

            loadedFiles.push(fileEntry);
            actualizarDistritos();
            aplicarFiltros();
            alert(`¡Listo! Cargados ${fileEntry.markers.length} puntos del archivo ${filename}.`);
        }

        function actualizarDistritos() {
            const allDistritos = new Set();
            loadedFiles.forEach(file => {
                file.data.forEach(row => {
                    if (row.DISTRITO) allDistritos.add(row.DISTRITO);
                });
            });
            const distritos = [...allDistritos].sort();
            const selectDist = document.getElementById('distritoFilter');
            selectDist.innerHTML = '<option value="">Selecciona distrito</option><option value="TODOS">TODOS DISTRITOS</option>';
            distritos.forEach(d => {
                let opt = document.createElement('option');
                opt.value = d; opt.text = d;
                selectDist.appendChild(opt);
            });
        }
         
        function getAllVisibleMarkers() {
            let markers = [];
            loadedFiles.forEach(file => {
                if (file.visible) markers = markers.concat(file.markers);
            });
            return markers;
        }

        function actualizarConteos() {
            const markers = getAllVisibleMarkers();
            const c = { A1:0, A2:0, A3:0, IMPOSIBILIDAD:0, PROYECTO:0, total: markers.length };
            markers.forEach(m => {
                if (c.hasOwnProperty(m.properties.tipoFiltro)) c[m.properties.tipoFiltro]++;
            });
            document.getElementById('modalCountA1').textContent = c.A1;
            document.getElementById('modalCountA2').textContent = c.A2;
            document.getElementById('modalCountA3').textContent = c.A3;
            document.getElementById('modalCountIMP').textContent = c.IMPOSIBILIDAD;
            document.getElementById('modalCountPROY').textContent = c.PROYECTO;
            document.getElementById('modalCountTotal').textContent = c.total;
            document.getElementById('modalSelectionCount').textContent = selectedMarkers.length;
        }

        function verConteo() {
            actualizarConteos();
            document.getElementById('conteoModal').style.display = 'flex';
        }

        function getAllVisibleData() {
            let data = [];
            loadedFiles.forEach(file => {
                if (file.visible) data = data.concat(file.data);
            });
            return data;
        }

        function verReportePorLocalidad() {
            const datos = getAllVisibleData();
            if (datos.length === 0) {
                document.getElementById('reporteContenido').innerHTML = 'No hay datos visibles.';
                document.getElementById('btnExportReporte').style.display = 'none';
                document.getElementById('reporteModal').style.display = 'flex';
                return;
            }

            const porDistrito = {};
            const totales = { A1:0, A2:0, A3:0, IMPOSIBILIDAD:0, PROYECTO:0, total:0 };
            reporteData = [];

            datos.forEach(row => {
                const distrito = row.DISTRITO || 'SIN DISTRITO';
                if (!porDistrito[distrito]) porDistrito[distrito] = { A1:0, A2:0, A3:0, IMPOSIBILIDAD:0, PROYECTO:0, total:0 };

                let tipo = 'PROYECTO';
                const act = (row.ACTIVIDAD || '').toString().trim().toUpperCase();
                if (act === 'A1') tipo = 'A1';
                else if (act === 'A2') tipo = 'A2';
                else if (act === 'A3') tipo = 'A3';
                else if (act === 'IMPOSIBILIDAD') tipo = 'IMPOSIBILIDAD';

                porDistrito[distrito][tipo]++;
                porDistrito[distrito].total++;

                totales[tipo]++;
                totales.total++;
            });

            let html = '<table style="width:100%; border-collapse:collapse;"><tr><th>Distrito</th><th>A1</th><th>A2</th><th>A3</th><th>Impos.</th><th>Proy.</th><th>Total</th></tr>';
            Object.keys(porDistrito).sort().forEach(dist => {
                const d = porDistrito[dist];
                html += `<tr><td>${dist}</td><td>${d.A1}</td><td>${d.A2}</td><td>${d.A3}</td><td>${d.IMPOSIBILIDAD}</td><td>${d.PROYECTO}</td><td>${d.total}</td></tr>`;
                reporteData.push({Distrito: dist, A1: d.A1, A2: d.A2, A3: d.A3, Imposibilidad: d.IMPOSIBILIDAD, Proyecto: d.PROYECTO, Total: d.total});
            });

            html += `<tr style="font-weight:bold; background:#f0f0f0;"><td><strong>TOTAL GENERAL</strong></td><td><strong>${totales.A1}</strong></td><td><strong>${totales.A2}</strong></td><td><strong>${totales.A3}</strong></td><td><strong>${totales.IMPOSIBILIDAD}</strong></td><td><strong>${totales.PROYECTO}</strong></td><td><strong>${totales.total}</strong></td></tr>`;
            html += '</table>';

            reporteData.push({Distrito: 'TOTAL GENERAL', A1: totales.A1, A2: totales.A2, A3: totales.A3, Imposibilidad: totales.IMPOSIBILIDAD, Proyecto: totales.PROYECTO, Total: totales.total});

            document.getElementById('reporteContenido').innerHTML = html;
            document.getElementById('btnExportReporte').style.display = 'block';
            document.getElementById('reporteModal').style.display = 'flex';
        }

        function exportarReporteLocalidadExcel() {
            if (reporteData.length === 0) return alert("No hay datos para exportar.");
            const ws = XLSX.utils.json_to_sheet(reporteData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reporte por Localidad");
            XLSX.writeFile(wb, "reporte_por_localidad.xlsx");
        }

        function abrirFiltroVisibilidad() {
            document.getElementById('visA1').checked = visibilidad.A1;
            document.getElementById('visA2').checked = visibilidad.A2;
            document.getElementById('visA3').checked = visibilidad.A3;
            document.getElementById('visIMP').checked = visibilidad.IMPOSIBILIDAD;
            document.getElementById('visProyecto').checked = visibilidad.PROYECTO;
            document.getElementById('filtroModal').style.display = 'flex';
        }

        function aplicarFiltroVisibilidad() {
            visibilidad.A1 = document.getElementById('visA1').checked;
            visibilidad.A2 = document.getElementById('visA2').checked;
            visibilidad.A3 = document.getElementById('visA3').checked;
            visibilidad.IMPOSIBILIDAD = document.getElementById('visIMP').checked;
            visibilidad.PROYECTO = document.getElementById('visProyecto').checked;
            cerrarModal('filtroModal');
            aplicarFiltros();
        }

        function abrirArchivosModal() {
            if (loadedFiles.length === 0) {
                alert('No hay archivos cargados.');
                return;
            }
            let html = '';
            loadedFiles.forEach((file, index) => {
                html += `<label><input type="checkbox" class="file-vis" data-index="${index}" ${file.visible ? 'checked' : ''}> ${file.filename}</label><br>`;
            });
            document.getElementById('filesList').innerHTML = html;
            document.getElementById('filesModal').style.display = 'flex';
        }

        function aplicarVisibilidadArchivos() {
            const checkboxes = document.querySelectorAll('.file-vis');
            checkboxes.forEach(cb => {
                const index = parseInt(cb.dataset.index);
                loadedFiles[index].visible = cb.checked;
            });
            cerrarModal('filesModal');
            aplicarFiltros();
        }

        function cerrarModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) event.target.style.display = 'none';
        }

        
            function aplicarFiltros() {
            loadedFiles.forEach(file => {
                if (map.hasLayer(file.clusterGroup)) map.removeLayer(file.clusterGroup);
                if (map.hasLayer(file.individualLayer)) map.removeLayer(file.individualLayer);
                file.clusterGroup.clearLayers();
                file.individualLayer.clearLayers();
             });

                const distrito = document.getElementById('distritoFilter').value;

     
            loadedFiles.forEach(file => {
                if (!file.visible) return;



                 file.markers.forEach(m => {
                    if (distrito !== '' && distrito !== 'TODOS' && m.properties.DISTRITO !== distrito) return;
                    if (!visibilidad[m.properties.tipoFiltro]) return;

                    const marker = crearMarcador(m.getLatLng().lat, m.getLatLng().lng, m.properties.color);
                    marker.properties = m.properties;
                    marker.bindPopup(m._popup._content);
                    marker.on('click', e => modoClic ? toggleSeleccionMarker(marker) : map.openPopup(marker.getPopup()));

                    file.clusterGroup.addLayer(marker);
                    file.individualLayer.addLayer(marker);
                });

                selectedMarkers.forEach(p => {
                    if (p.filename !== file.filename) return;
                    const marker = crearMarcador(p.LATITUD, p.LONGITUD, '#00ff00');
                    marker.properties = p;
                    marker.setStyle({radius: 9});
                    marker.on('click', () => modoClic && toggleSeleccionMarker(marker));
                    file.individualLayer.addLayer(marker);
                });
            });











            controlarVistaPorZoom();
        }

        function controlarVistaPorZoom() {
            const zoom = map.getZoom();
            loadedFiles.forEach(file => {
                if (!file.visible) return;
                if (zoom >= 16) {
                    map.removeLayer(file.clusterGroup);
                    map.addLayer(file.individualLayer);
                } else {
                    map.removeLayer(file.individualLayer);
                    map.addLayer(file.clusterGroup);
                }
            });
        }

        function toggleModoClic() {
            modoClic = !modoClic;
            map.getContainer().style.cursor = modoClic ? 'crosshair' : 'grab';
            document.getElementById('btnSeleccionar').classList.toggle('active', modoClic);
            if (modoClic) alert("Modo selección activado. Haz clic en los puntos para seleccionarlos.");
            aplicarFiltros();
        }

        function toggleSeleccionMarker(marker) {
            const props = marker.properties;
            const key = props.ID ? props.ID : `${props.LATITUD}_${props.LONGITUD}`;
            const index = selectedMarkers.findIndex(s => (s.ID ? s.ID : `${s.LATITUD}_${s.LONGITUD}`) === key);
            if (index === -1) {
                selectedMarkers.push(props);
                marker.setStyle({fillColor: '#00ff00', radius: 9});
            } else {
                selectedMarkers.splice(index, 1);
                marker.setStyle({fillColor: props.color, radius: 6});
            }
        }

        function limpiarSeleccion() {
            selectedMarkers = [];
            aplicarFiltros();
        }

        function limpiarMapa() {
            loadedFiles = [];
            selectedMarkers = [];
            actualizarDistritos();
            aplicarFiltros();
        }








        map.on('zoomend', controlarVistaPorZoom);
        document.getElementById('distritoFilter').addEventListener('change', aplicarFiltros);

        document.getElementById('search-box').addEventListener('input', function() {
            const term = this.value.trim().toLowerCase();
            if (!term) {
                aplicarFiltros();
                return;
            }

            loadedFiles.forEach(file => {
                map.removeLayer(file.clusterGroup);
                map.removeLayer(file.individualLayer);
                file.clusterGroup.clearLayers();
                file.individualLayer.clearLayers();
            });

            const distrito = document.getElementById('distritoFilter').value;
            const bounds = L.latLngBounds();

            loadedFiles.forEach(file => {
                if (!file.visible) return;

                const encontrados = file.markers.filter(m => {
                    if (distrito !== '' && distrito !== 'TODOS' && m.properties.DISTRITO !== distrito) return false;
                    if (!visibilidad[m.properties.tipoFiltro]) return false;

                    return (m.properties.ID?.toString().toLowerCase().includes(term)) ||
                           (m.properties.DIRECCION?.toLowerCase().includes(term)) ||
                           (m.properties.MEDIDOR?.toString().toLowerCase().includes(term));
                });

                encontrados.forEach(m => {
                    const marker = crearMarcador(m.getLatLng().lat, m.getLatLng().lng, m.properties.color);
                    marker.properties = m.properties;
                    marker.bindPopup(m._popup._content);
                    marker.on('click', e => modoClic ? toggleSeleccionMarker(marker) : map.openPopup(marker.getPopup()));

                    file.clusterGroup.addLayer(marker);
                    file.individualLayer.addLayer(marker);

                    bounds.extend([m.getLatLng().lat, m.getLatLng().lng]);
                });
            });

            const allEncontrados = getAllVisibleMarkers().filter(m => {
                return (m.properties.ID?.toString().toLowerCase().includes(term)) ||
                       (m.properties.DIRECCION?.toLowerCase().includes(term)) ||
                       (m.properties.MEDIDOR?.toString().toLowerCase().includes(term));
            });

            if (allEncontrados.length === 0) {
                alert("No se encontraron coincidencias.");
                return;
            }

            if (allEncontrados.length === 1) {
                map.setView(allEncontrados[0].getLatLng(), 18);
            } else {
                map.fitBounds(bounds, { padding: [50, 50] });
            }

            controlarVistaPorZoom();
        });

        function exportarSeleccionPDF() {
            if (selectedMarkers.length === 0) return alert("No hay puntos seleccionados.");
            const doc = new jsPDF('l', 'mm', 'a4');
            doc.setFontSize(16);
            doc.text("Reporte de Puntos Seleccionados - Agua Potable", 14, 20);
            doc.setFontSize(12);
            doc.text(`Total: ${selectedMarkers.length} puntos | Fecha: ${new Date().toLocaleDateString('es-PE')}`, 14, 30);

            const headers = [["N°", "ID", "Tipo", "Medidor", "Dirección", "Distrito", "Lat", "Lon", "Archivo"]];
            const data = selectedMarkers.map((p, i) => [
                i+1,
                p.ID || 'N/D',
                p.tipoFiltro,
                p.MEDIDOR || 'SIN',
                p.DIRECCION || '',
                p.DISTRITO || '',
                parseFloat(p.LATITUD).toFixed(6),
                parseFloat(p.LONGITUD).toFixed(6),
                p.filename || ''
            ]);

            doc.autoTable({ head: headers, body: data, startY: 40, theme: 'grid', headStyles: { fillColor: [29, 78, 216] } });
            doc.save("reporte_seleccionados.pdf");
        }

        function exportarSeleccionExcel() {
            if (selectedMarkers.length === 0) return alert("No hay puntos seleccionados.");
            const data = selectedMarkers.map(p => ({
                ID: p.ID || 'N/D',
                Tipo: p.tipoFiltro,
                Medidor: p.MEDIDOR || 'SIN MEDIDOR',
                Direccion: p.DIRECCION || '',
                Distrito: p.DISTRITO || '',
                Latitud: p.LATITUD,
                Longitud: p.LONGITUD,
                Actividad: p.ACTIVIDAD || 'SIN DATO',
                Archivo: p.filename || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Seleccionados");
            XLSX.writeFile(wb, "reporte_seleccionados.xlsx");
        }

        function imprimirMapaNormal() {
            if (loadedFiles.length === 0) return alert("Primero carga un archivo Excel con puntos.");
            const fecha = new Date().toLocaleDateString('es-PE');
            document.body.setAttribute('data-print-date', fecha);
            window.print();
        }







        function toggleLocation() {
            isLocationActive = !isLocationActive;
            ubicacionControl.updateActiveState();

            if (isLocationActive) {
                if (!navigator.geolocation) {
                    alert('La geolocalización no está disponible en este navegador.');
                    isLocationActive = false;
                    ubicacionControl.updateActiveState();
                    return;
                }

                firstLocationReceived = false;

                locationWatcher = navigator.geolocation.watchPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;

                        if (!locationMarker) {
                            locationMarker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    html: '<div style="background:#3b82f6;width:20px;height:20px;border-radius:50%;border:3px solid white;"></div>',
                                    className: '',
                                    iconSize: [20,20],
                                    iconAnchor: [10,10]
                                })
                            }).addTo(map).bindPopup('Tu ubicación actual');
                        } else {
                            locationMarker.setLatLng([lat, lng]);
                        }

                        if (!locationAccuracyCircle) {
                            locationAccuracyCircle = L.circle([lat, lng], {
                                radius: accuracy,
                                color: '#3b82f6',
                                fillColor: '#93c5fd',
                                fillOpacity: 0.2
                            }).addTo(map);
                        } else {
                            locationAccuracyCircle.setLatLng([lat, lng]);
                            locationAccuracyCircle.setRadius(accuracy);
                        }

                        if (!firstLocationReceived) {
                            map.setView([lat, lng], 16);
                            firstLocationReceived = true;
                        }
                    },
                    function(error) {
                        alert('Error al obtener ubicación: ' + error.message);
                        isLocationActive = false;
                        ubicacionControl.updateActiveState();
                    },
                    { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
                );
            } else {
                if (locationWatcher) navigator.geolocation.clearWatch(locationWatcher);
                if (locationMarker) map.removeLayer(locationMarker);
                if (locationAccuracyCircle) map.removeLayer(locationAccuracyCircle);
                locationMarker = null;
                locationAccuracyCircle = null;
            }
        }

        window.addEventListener('beforeunload', () => {
            if (locationWatcher) navigator.geolocation.clearWatch(locationWatcher);
        });

        map.on('zoomend', controlarVistaPorZoom);
        document.getElementById('distritoFilter').addEventListener('change', aplicarFiltros);

        document.getElementById('search-box').addEventListener('input', function() {
            const term = this.value.trim().toLowerCase();
            if (!term) {
                aplicarFiltros();
                return;
            }

            loadedFiles.forEach(file => {
                map.removeLayer(file.clusterGroup);
                map.removeLayer(file.individualLayer);
                file.clusterGroup.clearLayers();
                file.individualLayer.clearLayers();
            });

            const distrito = document.getElementById('distritoFilter').value;

            loadedFiles.forEach(file => {
                if (!file.visible) return;

                const encontrados = file.markers.filter(m => {
                    if (distrito !== '' && distrito !== 'TODOS' && m.properties.DISTRITO !== distrito) return false;
                    if (!visibilidad[m.properties.tipoFiltro]) return false;

                    return (m.properties.ID?.toString().toLowerCase().includes(term)) ||
                           (m.properties.DIRECCION?.toLowerCase().includes(term)) ||
                           (m.properties.MEDIDOR?.toString().toLowerCase().includes(term));
                });

                encontrados.forEach(m => {
                    const marker = crearMarcador(m.getLatLng().lat, m.getLatLng().lng, m.properties.color);
                    marker.properties = m.properties;
                    marker.bindPopup(m._popup._content);
                    marker.on('click', e => modoClic ? toggleSeleccionMarker(marker) : map.openPopup(marker.getPopup()));

                    file.clusterGroup.addLayer(marker);
                    file.individualLayer.addLayer(marker);
                });
            });

            controlarVistaPorZoom();
        });

    </script>
</body>
</html>
