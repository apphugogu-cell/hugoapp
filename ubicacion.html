<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Conexiones Agua Potable - La Libertad</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2@3.2.3/css/leaflet-sidebar.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <style>
        body { margin:0; padding:0; font-family: 'Segoe UI', Arial, sans-serif; background:#f8f9ff; }
        #map { height: 100vh; width: 100%; }
        
        .leaflet-sidebar {
            background: linear-gradient(to bottom, #ffffff 0%, #f0f7ff 100%) !important;
            color: #1a365d !important;
            border-right: 1px solid #bfdbfe;
            box-shadow: 0 0 25px rgba(0,0,0,0.08);
        }
        
        .leaflet-sidebar-tabs ul li a {
            background: #e0f2fe !important;
            color: #0369a1 !important;
        }
        
        .leaflet-sidebar-tabs ul li a:hover,
        .leaflet-sidebar-tabs ul li.active a {
            background: #bae6fd !important;
        }
        
        .leaflet-sidebar-header {
            background: #1d4ed8;
            color: white;
            padding: 8px;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 1px solid #3b82f6;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .leaflet-sidebar-content {
            padding: 12px 8px;
        }
        
        button {
            width: 100%;
            height: 18px;                    /* reducido a la mitad */
            font-size: 11px;                 /* fuente más pequeña */
            font-weight: 600;
            margin: 4px 0;                   /* menos espacio entre botones */
            padding: 0 8px;
            border-radius: 6px;
            border: none;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 1px 4px rgba(59,130,246,0.25);
        }
        
        button i {
            font-size: 12px;                 /* iconos más pequeños */
        }
        
        button:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(59,130,246,0.35);
        }
        
        button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        button.danger {
            background: #ef4444 !important;
        }
        
        button.danger:hover:not(:disabled) {
            background: #dc2626 !important;
        }

        /* Botón activo en azul metálico */
        button.active {
            background: linear-gradient(135deg, #1e88e5, #1565c0) !important;
            box-shadow: 0 4px 12px rgba(30, 136, 229, 0.5) !important;
            transform: translateY(0) !important;
            border: 1px solid #0d47a1;
        }

        select, input[type="text"], input[type="file"] {
            width: 100%;
            padding: 8px 10px;
            font-size: 12px;
            border: 1px solid #93c5fd;
            border-radius: 6px;
            margin: 6px 0;
            background: white;
        }
        
        select:focus, input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59,130,246,0.15);
        }

        #leyenda {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px 14px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            font-size: 12px;
            border: 1px solid #e5e7eb;
            z-index: 1000;
        }
        
        .leyenda-item { display: flex; align-items: center; margin: 4px 0; }
        .leyenda-color { width: 14px; height: 14px; border-radius: 50%; margin-right: 8px; border: 1px solid #666; }
        
        .legend-toggle {
            position: absolute;
            bottom: 90px;
            right: 30px;
            z-index: 1001;
            background: white;
            border: 2px solid #4682b4;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
            font-size: 16px;
            color: #4682b4;
        }
        
        .legend-toggle:hover {
            background: #4682b4;
            color: white;
            transform: scale(1.08);
        }
        
        #leyenda.hidden { display: none !important; }
        
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0; top: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); 
            justify-content: center; 
            align-items: center; 
        }
        .modal-content { 
            background: white; 
            padding: 16px; 
            border-radius: 10px; 
            width: 90%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .close { float: right; font-size: 24px; cursor: pointer; color: #666; }

        #detallePunto {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 180px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.18);
            padding: 12px;
            z-index: 1000;
            display: none;
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid #bfdbfe;
            font-size: 12px;
        }

        #detallePunto h3 {
            margin: 0 0 10px 0;
            color: #1d4ed8;
            font-size: 16px;
            text-align: center;
        }

        #detallePunto .dato {
            margin: 6px 0;
            line-height: 1.3;
        }

        #detallePunto .label {
            font-weight: bold;
            color: #1d4ed8;
            display: inline-block;
            width: 90px;
        }
    </style>
</head>
<body data-print-date="">
    <div id="map"></div>

    <div id="detallePunto">
        <h3 id="tituloSuministro">SUMINISTRO</h3>
        <div id="contenidoDetalle"></div>
    </div>

    <div id="sidebar" class="leaflet-sidebar collapsed">
        <div class="leaflet-sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
            </ul>
        </div>

        <div class="leaflet-sidebar-content">
            <div class="leaflet-sidebar-pane active" id="home">
                <h1 class="leaflet-sidebar-header">
                    <i class="fa fa-tint"></i> Agua Potable
                    <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                
                <input type="file" id="excelFile" accept=".xlsx" multiple />
                
                <button id="btn-matriz" style="background:#7c3aed; color:white; margin:6px 0;">
                    <i class="fa fa-database"></i> Matriz
                </button>
                
                <select id="distritoFilter">
                    <option value="">Distrito</option>
                </select>
                
                <button onclick="abrirGestionArchivos()"><i class="fa fa-folder"></i> Archivos</button>
                
                <div style="margin-top:10px;">
                    <button id="btnConteo" disabled onclick="ejecutarConteo()"><i class="fa fa-chart-pie"></i> Conteo</button>
                    <button id="btnReporte" disabled onclick="ejecutarReporte()"><i class="fa fa-table"></i> Reporte</button>
                    <button id="btnFiltro" onclick="abrirFiltroVisibilidad()"><i class="fa fa-filter"></i> Filtro</button>
                </div>
                
                <button id="btnSeleccionar" onclick="toggleModoClic()"><i class="fa fa-hand-pointer"></i> Seleccionar</button>
                <button onclick="limpiarSeleccion()"><i class="fa fa-eraser"></i> Limpiar</button>
                
                <button onclick="prepararAgrupamiento()"><i class="fa fa-object-group"></i> Agrupar</button>
                
                <button onclick="imprimirMapaNormal()"><i class="fa fa-print"></i> Imprimir</button>
                
                <hr style="margin:10px 0;">
                
                <input type="text" id="search-box" placeholder="SUMINISTRO">
                
                <div id="export-buttons" style="margin-top:10px;">
                    <button onclick="exportarSeleccionPDF()"><i class="fa fa-file-pdf"></i> PDF</button>
                    <button onclick="exportarSeleccionExcel()"><i class="fa fa-file-excel"></i> XLS</button>
                </div>
            </div>
        </div>
    </div>

    <div id="leyenda" class="hidden">
        <strong>Leyenda</strong><br>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#d32f2f;"></div>A1</div>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#ffeb3b;"></div>A2</div>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#4caf50;"></div>A3</div>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#212121;"></div>Imp</div>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#4682b4;"></div>Proy</div>
        <div class="leyenda-item"><div class="leyenda-color" style="background:#ff9800;"></div>Campo</div>
    </div>

    <div class="legend-toggle" id="toggleLeyenda" title="Mostrar/Ocultar leyenda">
        <i class="fa fa-eye"></i>
    </div>

    <div id="conteoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('conteoModal')">×</span>
            <h4>Conteo</h4>
            <div>A1: <span id="modalCountA1">0</span></div>
            <div>A2: <span id="modalCountA2">0</span></div>
            <div>A3: <span id="modalCountA3">0</span></div>
            <div>Imp: <span id="modalCountIMP">0</span></div>
            <div>Proy: <span id="modalCountPROY">0</span></div>
            <div>Campo: <span id="modalCountVERCAMPO">0</span></div>
            <hr>
            <div>Total: <span id="modalCountTotal">0</span></div>
        </div>
    </div>

    <div id="reporteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('reporteModal')">×</span>
            <h4>Reporte</h4>
            <div id="reporteContenido"></div>
        </div>
    </div>

    <div id="gestionArchivosModal" class="modal">
        <div class="modal-content" style="width:420px;">
            <span class="close" onclick="cerrarModal('gestionArchivosModal')">×</span>
            <h4>Archivos</h4>
            <div id="gestionFilesList" style="margin: 10px 0; max-height:300px; overflow-y:auto;"></div>
            <button onclick="aplicarGestionArchivos()" style="margin-top:10px; background:#16a34a; color:white; padding:8px; width:100%;">
                Aplicar
            </button>
        </div>
    </div>

    <div id="filtroModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('filtroModal')">×</span>
            <h4>Filtro</h4>
            <div style="text-align: left; margin: 10px 0; font-size:12px;">
                <label><input type="checkbox" id="visA1" checked> A1</label><br>
                <label><input type="checkbox" id="visA2" checked> A2</label><br>
                <label><input type="checkbox" id="visA3" checked> A3</label><br>
                <label><input type="checkbox" id="visIMP" checked> Imp</label><br>
                <label><input type="checkbox" id="visProyecto" checked> Proy</label><br>
                <label><input type="checkbox" id="visVERENCAMPO" checked> Campo</label>
            </div>
            <button onclick="aplicarFiltroVisibilidad()" style="margin-top:10px; background:#1d4ed8; color:white; padding:8px; width:100%;">
                Aplicar
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-sidebar-v2@3.2.3/js/leaflet-sidebar.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js"></script>

    <script>
        const { jsPDF } = window.jspdf;

        var map = L.map('map').setView([-7.8, -78.5], 9);

        var baseLayers = {
            "Calles": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }),
            "Satélite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' })
        };
        baseLayers["Calles"].addTo(map);
        L.control.layers(baseLayers, null, {position: 'topright'}).addTo(map);

        var loadedFiles = [];
        var selectedMarkers = [];
        var modoClic = false;

        var locationWatcher = null;
        var locationMarker = null;
        var locationAccuracyCircle = null;
        var isLocationActive = false;
        var firstLocationReceived = false;

        var visibilidad = {
            A1: true,
            A2: true,
            A3: true,
            IMPOSIBILIDAD: true,
            PROYECTO: true,
            VERENCAMPO: true
        };

        var sidebar = L.control.sidebar({
            container: 'sidebar',
            position: 'left',
            closeButton: true,
            autopan: false
        }).addTo(map);

        function normalizarSuministro(s) {
            if (!s) return '';
            return s.toString().trim().replace(/\s+/g, ' ').toUpperCase();
        }

        function tienePalabraCampo(texto) {
            if (!texto) return false;
            return texto.toString().toLowerCase().includes('campo');
        }

        function getColor(tipo) {
            switch(tipo) {
                case 'A1': return '#d32f2f';
                case 'A2': return '#ffeb3b';
                case 'A3': return '#4caf50';
                case 'IMPOSIBILIDAD': return '#212121';
                case 'PROYECTO': return '#4682b4';
                case 'VERENCAMPO': return '#ff9800';
                default: return '#888888';
            }
        }

        function crearMarcador(lat, lng, color) {
            return L.circleMarker([lat, lng], {
                radius: 6,
                fillColor: color,
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.85
            });
        }

        document.getElementById('btn-matriz').addEventListener('click', function() {
            document.getElementById('excelFile').click();
        });

        document.getElementById('excelFile').addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length === 0) return;

            let conUbicacionPropia = 0;
            let ubicadosPorMatriz = 0;
            let noUbicados = 0;

            Array.from(files).forEach(file => {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, {type: 'array'});
                    var sheet = workbook.Sheets[workbook.SheetNames[0]];
                    var json = XLSX.utils.sheet_to_json(sheet, {defval: ""});

                    const fileEntry = {
                        filename: file.name,
                        data: json,
                        markers: [],
                        clusterGroup: L.markerClusterGroup({
                            chunkedLoading: true,
                            disableClusteringAtZoom: 16,
                            maxClusterRadius: 50
                        }),
                        individualLayer: L.layerGroup(),
                        visible: true,
                        selectedForAnalysis: true
                    };

                    json.forEach(row => {
                        let lat = parseFloat(row.LATITUD || row.LAT || row.Latitud);
                        let lng = parseFloat(row.LONGITUD || row.LON || row.Longitud);

                        if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) {
                            let suministro = normalizarSuministro(row.SUMINISTRO || row['SUMINISTRO'] || row['N° SUMINISTRO'] || row['COD SUMINISTRO']);
                            if (suministro && matrizUbicaciones.has(suministro)) {
                                const info = matrizUbicaciones.get(suministro);
                                lat = info.lat;
                                lng = info.lng;
                                ubicadosPorMatriz++;
                            } else {
                                noUbicados++;
                                return;
                            }
                        } else {
                            conUbicacionPropia++;
                            let suministro = normalizarSuministro(row.SUMINISTRO || row['SUMINISTRO']);
                            if (suministro) {
                                matrizUbicaciones.set(suministro, {lat, lng});
                            }
                        }

                        const textoCampo = [
                            row['VER EN CAMPO'],
                            row['VER_EN_CAMPO'],
                            row['VERENCAMPO'],
                            row.ACTIVIDAD,
                            row.OBSERVACION,
                            row.NOTAS
                        ].filter(Boolean).join(' ').toLowerCase();

                        const esVerEnCampo = tienePalabraCampo(textoCampo);

                        const actividadRaw = (row.ACTIVIDAD || '').toString().trim().toUpperCase();
                        let tipo = 'PROYECTO';
                        
                        if (esVerEnCampo) {
                            tipo = 'VERENCAMPO';
                        } else if (actividadRaw === 'A1') {
                            tipo = 'A1';
                        } else if (actividadRaw === 'A2') {
                            tipo = 'A2';
                        } else if (actividadRaw === 'A3') {
                            tipo = 'A3';
                        } else if (actividadRaw === 'IMPOSIBILIDAD') {
                            tipo = 'IMPOSIBILIDAD';
                        }

                        const color = getColor(tipo);
                        var marker = crearMarcador(lat, lng, color);
                        
                        marker.properties = { ...row, tipoFiltro: tipo, color: color, filename: file.name };

                        const suministroMostrar = row.SUMINISTRO || row['SUMINISTRO'] || row['N° SUMINISTRO'] || row['COD SUMINISTRO'] || 'SIN SUMINISTRO';

                        const popupSimple = `
                            <div style="text-align:center; padding:4px;">
                                <div style="width: 32px; height: 32px; background: #d32f2f; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.4); margin: 0 auto;"></div>
                            </div>
                        `;

                        marker.bindPopup(popupSimple, { maxWidth: 60, closeButton: false });

                        marker.on('click', function(e) {
                            if (modoClic) {
                                toggleSeleccionMarker(this);
                            } else {
                                mostrarDetallePunto(this.properties);
                                map.openPopup(this.getPopup());
                            }
                        });

                        fileEntry.markers.push(marker);
                        fileEntry.clusterGroup.addLayer(marker);
                        fileEntry.individualLayer.addLayer(marker);
                    });

                    loadedFiles.push(fileEntry);
                    actualizarDistritos();
                    aplicarFiltros();
                    actualizarBotonesAnalisis();

                    alert(`¡Listo! Cargados ${fileEntry.markers.length} puntos del archivo ${file.name}.\n` +
                          `Con ubicación propia: ${conUbicacionPropia}\n` +
                          `Ubicados con matriz: ${ubicadosPorMatriz}\n` +
                          `Sin ubicación encontrada: ${noUbicados}`);
                };
                reader.readAsArrayBuffer(file);
            });
            e.target.value = '';
        });

        function mostrarDetallePunto(props) {
            const suministro = props.SUMINISTRO || props['SUMINISTRO'] || props['N° SUMINISTRO'] || props['COD SUMINISTRO'] || 'SIN SUMINISTRO';
            const medidor = props.MEDIDOR || 'SIN MEDIDOR';
            const actividad = props.ACTIVIDAD || 'SIN DATO';
            const usuario = props.Usuario || '—';
            const direccion = props.DIRECCION || '—';
            const distrito = props.DISTRITO || '—';
            const verCampo = tienePalabraCampo([
                props['VER EN CAMPO'],
                props['VER_EN_CAMPO'],
                props['VERENCAMPO'],
                props.ACTIVIDAD,
                props.OBSERVACION,
                props.NOTAS
            ].join(' ')) ? 'SÍ' : 'NO';

            document.getElementById('tituloSuministro').textContent = suministro;
            document.getElementById('contenidoDetalle').innerHTML = `
                <div class="dato"><span class="label">Medidor:</span> ${medidor}</div>
                <div class="dato"><span class="label">Actividad:</span> ${actividad}</div>
                <div class="dato"><span class="label">Usuario:</span> ${usuario}</div>
                <div class="dato"><span class="label">Dirección:</span> ${direccion}</div>
                <div class="dato"><span class="label">Distrito:</span> ${distrito}</div>
                <div class="dato"><span class="label">Ver Campo:</span> ${verCampo}</div>
            `;

            document.getElementById('detallePunto').style.display = 'block';
        }

        function limpiarDetallePunto() {
            document.getElementById('detallePunto').style.display = 'none';
        }

        function toggleModoClic() {
            modoClic = !modoClic;
            const btn = document.getElementById('btnSeleccionar');
            if (modoClic) {
                btn.classList.add('active');
                map.getContainer().style.cursor = 'crosshair';
                alert("Modo selección activado.");
            } else {
                btn.classList.remove('active');
                map.getContainer().style.cursor = 'grab';
                limpiarDetallePunto();
            }
            aplicarFiltros();
        }

        function limpiarSeleccion() {
            selectedMarkers = [];
            limpiarDetallePunto();
            aplicarFiltros();
        }

        function actualizarDistritos() {
            const allDistritos = new Set();
            loadedFiles.forEach(file => {
                file.data.forEach(row => {
                    if (row.DISTRITO) allDistritos.add(row.DISTRITO);
                });
            });
            const distritos = [...allDistritos].sort();
            const selectDist = document.getElementById('distritoFilter');
            selectDist.innerHTML = '<option value="">Selecciona distrito</option><option value="TODOS">TODOS</option>';
            distritos.forEach(d => {
                let opt = document.createElement('option');
                opt.value = d; opt.text = d;
                selectDist.appendChild(opt);
            });
        }

        function getAllVisibleMarkers() {
            let markers = [];
            loadedFiles.forEach(file => {
                if (file.visible) markers = markers.concat(file.markers);
            });
            return markers;
        }

        function getSelectedVisibleMarkers() {
            let markers = [];
            loadedFiles.forEach(file => {
                if (file.visible && file.selectedForAnalysis) {
                    markers = markers.concat(file.markers);
                }
            });
            return markers;
        }

        function actualizarConteos() {
            const markers = getSelectedVisibleMarkers();
            const c = { A1:0, A2:0, A3:0, IMPOSIBILIDAD:0, PROYECTO:0, VERENCAMPO:0, total: markers.length };
            markers.forEach(m => {
                if (c.hasOwnProperty(m.properties.tipoFiltro)) c[m.properties.tipoFiltro]++;
            });
            document.getElementById('modalCountA1').textContent = c.A1;
            document.getElementById('modalCountA2').textContent = c.A2;
            document.getElementById('modalCountA3').textContent = c.A3;
            document.getElementById('modalCountIMP').textContent = c.IMPOSIBILIDAD;
            document.getElementById('modalCountPROY').textContent = c.PROYECTO;
            document.getElementById('modalCountVERCAMPO').textContent = c.VERENCAMPO;
            document.getElementById('modalCountTotal').textContent = c.total;
            document.getElementById('modalSelectionCount').textContent = selectedMarkers.length;
        }

        function actualizarBotonesAnalisis() {
            const tieneArchivosSeleccionados = loadedFiles.some(f => f.visible && f.selectedForAnalysis);
            document.getElementById('btnConteo').disabled = !tieneArchivosSeleccionados;
            document.getElementById('btnReporte').disabled = !tieneArchivosSeleccionados;
        }

        function abrirGestionArchivos() {
            if (loadedFiles.length === 0) return alert('No hay archivos cargados.');

            let html = '';
            loadedFiles.forEach((file, index) => {
                const visChecked = file.visible ? 'checked' : '';
                html += `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:#f1f5f9; margin:6px 0; border-radius:6px; border:1px solid #e2e8f0; font-size:12px;">
                        <div style="flex:1;">
                            <strong>${file.filename}</strong><br>
                            <small>${file.markers.length} pts</small>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <label title="Visible / Analizar">
                                <input type="checkbox" class="file-vis" data-index="${index}" ${visChecked}>
                            </label>
                            <button class="danger" style="width:auto; height:20px; padding:0 6px; font-size:10px;" 
                                    onclick="eliminarArchivo(${index})">X</button>
                        </div>
                    </div>
                `;
            });

            document.getElementById('gestionFilesList').innerHTML = html;
            document.getElementById('gestionArchivosModal').style.display = 'flex';
        }

        function eliminarArchivo(index) {
            if (!confirm(`¿Eliminar "${loadedFiles[index].filename}"?`)) return;

            const file = loadedFiles[index];
            if (map.hasLayer(file.clusterGroup)) map.removeLayer(file.clusterGroup);
            if (map.hasLayer(file.individualLayer)) map.removeLayer(file.individualLayer);

            loadedFiles.splice(index, 1);
            actualizarDistritos();
            aplicarFiltros();
            actualizarBotonesAnalisis();
            abrirGestionArchivos();
        }

        function aplicarGestionArchivos() {
            document.querySelectorAll('.file-vis').forEach(cb => {
                const idx = parseInt(cb.dataset.index);
                loadedFiles[idx].visible = cb.checked;
                loadedFiles[idx].selectedForAnalysis = cb.checked;
            });

            aplicarFiltros();
            actualizarBotonesAnalisis();
            cerrarModal('gestionArchivosModal');
        }

        function ejecutarConteo() {
            actualizarConteos();
            document.getElementById('conteoModal').style.display = 'flex';
        }

        function ejecutarReporte() {
            const datos = [];
            loadedFiles.forEach(file => {
                if (file.visible && file.selectedForAnalysis) {
                    datos.push(...file.data);
                }
            });

            if (datos.length === 0) {
                alert('No hay archivos seleccionados.');
                return;
            }

            const porDistrito = {};
            const totales = { A1:0, A2:0, A3:0, IMPOSIBILIDAD:0, PROYECTO:0, VERENCAMPO:0, total:0 };

            datos.forEach(row => {
                const distrito = row.DISTRITO || 'SIN DISTRITO';
                if (!porDistrito[distrito]) porDistrito[distrito] = { A1:0, A2:0, A3:0, IMPOSIBILIDAD:0, PROYECTO:0, VERENCAMPO:0, total:0 };

                const textoCampo = [
                    row['VER EN CAMPO'],
                    row['VER_EN_CAMPO'],
                    row['VERENCAMPO'],
                    row.ACTIVIDAD,
                    row.OBSERVACION
                ].filter(Boolean).join(' ').toLowerCase();

                const esVerEnCampo = tienePalabraCampo(textoCampo);

                let tipo = 'PROYECTO';
                const act = (row.ACTIVIDAD || '').toString().trim().toUpperCase();
                
                if (esVerEnCampo) {
                    tipo = 'VERENCAMPO';
                } else if (act === 'A1') {
                    tipo = 'A1';
                } else if (act === 'A2') {
                    tipo = 'A2';
                } else if (act === 'A3') {
                    tipo = 'A3';
                } else if (act === 'IMPOSIBILIDAD') {
                    tipo = 'IMPOSIBILIDAD';
                }

                porDistrito[distrito][tipo]++;
                porDistrito[distrito].total++;
                totales[tipo]++;
                totales.total++;
            });

            let html = '<table style="width:100%; border-collapse:collapse; font-size:12px;"><tr><th>Distrito</th><th>A1</th><th>A2</th><th>A3</th><th>Imp</th><th>Proy</th><th>Campo</th><th>Total</th></tr>';
            Object.keys(porDistrito).sort().forEach(dist => {
                const d = porDistrito[dist];
                html += `<tr><td>${dist}</td><td>${d.A1}</td><td>${d.A2}</td><td>${d.A3}</td><td>${d.IMPOSIBILIDAD}</td><td>${d.PROYECTO}</td><td>${d.VERENCAMPO}</td><td>${d.total}</td></tr>`;
            });
            html += `<tr style="font-weight:bold; background:#f0f0f0;"><td>TOTAL</td><td>${totales.A1}</td><td>${totales.A2}</td><td>${totales.A3}</td><td>${totales.IMPOSIBILIDAD}</td><td>${totales.PROYECTO}</td><td>${totales.VERENCAMPO}</td><td>${totales.total}</td></tr></table>`;

            document.getElementById('reporteContenido').innerHTML = html;
            document.getElementById('reporteModal').style.display = 'flex';
        }

        function exportarSeleccionPDF() {
            if (selectedMarkers.length === 0) {
                alert("No hay puntos seleccionados.");
                return;
            }

            const doc = new jsPDF('p', 'mm', 'a4');
            doc.setFontSize(14);
            doc.text("Puntos Seleccionados", 20, 20);
            doc.setFontSize(10);
            doc.text(`Total: ${selectedMarkers.length} | ${new Date().toLocaleDateString('es-PE')}`, 20, 28);

            const headers = [["N°", "SUMINISTRO", "Tipo", "Medidor", "Dirección", "Distrito"]];
            const data = selectedMarkers.map((p, i) => [
                i + 1,
                p.SUMINISTRO || p['SUMINISTRO'] || p['N° SUMINISTRO'] || p['COD SUMINISTRO'] || 'SIN SUMINISTRO',
                p.tipoFiltro || '—',
                p.MEDIDOR || 'SIN',
                p.DIRECCION || '',
                p.DISTRITO || ''
            ]);

            doc.autoTable({
                head: headers,
                body: data,
                startY: 35,
                theme: 'grid',
                headStyles: { fillColor: [29, 78, 216], fontSize: 10 },
                columnStyles: {
                    0: { cellWidth: 8 },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 15 },
                    3: { cellWidth: 30 },
                    4: { cellWidth: 50 },
                    5: { cellWidth: 25 }
                }
            });

            doc.save("seleccionados.pdf");
        }

        function exportarSeleccionExcel() {
            if (selectedMarkers.length === 0) {
                alert("No hay puntos seleccionados.");
                return;
            }

            const data = selectedMarkers.map(p => ({
                SUMINISTRO: p.SUMINISTRO || p['SUMINISTRO'] || p['N° SUMINISTRO'] || p['COD SUMINISTRO'] || 'SIN SUMINISTRO',
                Tipo: p.tipoFiltro || '—',
                Medidor: p.MEDIDOR || 'SIN MEDIDOR',
                Direccion: p.DIRECCION || '',
                Distrito: p.DISTRITO || '',
                Actividad: p.ACTIVIDAD || 'SIN DATO',
                Usuario: p.Usuario || '—'
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Seleccionados");
            XLSX.writeFile(wb, "seleccionados.xlsx");
        }

        function aplicarFiltros() {
            loadedFiles.forEach(file => {
                if (map.hasLayer(file.clusterGroup)) map.removeLayer(file.clusterGroup);
                if (map.hasLayer(file.individualLayer)) map.removeLayer(file.individualLayer);
                file.clusterGroup.clearLayers();
                file.individualLayer.clearLayers();

                if (!file.visible) return;

                const distrito = document.getElementById('distritoFilter').value;

                file.markers.forEach(m => {
                    if (distrito !== '' && distrito !== 'TODOS' && m.properties.DISTRITO !== distrito) return;
                    if (!visibilidad[m.properties.tipoFiltro]) return;

                    const marker = crearMarcador(m.getLatLng().lat, m.getLatLng().lng, m.properties.color);
                    marker.properties = m.properties;
                    marker.bindPopup(m._popup._content);
                    marker.on('click', e => modoClic ? toggleSeleccionMarker(marker) : mostrarDetallePunto(m.properties));

                    file.clusterGroup.addLayer(marker);
                    file.individualLayer.addLayer(marker);
                });
            });
            controlarVistaPorZoom();
        }

        function controlarVistaPorZoom() {
            const zoom = map.getZoom();
            loadedFiles.forEach(file => {
                if (!file.visible) return;
                if (zoom >= 16) {
                    map.removeLayer(file.clusterGroup);
                    map.addLayer(file.individualLayer);
                } else {
                    map.removeLayer(file.individualLayer);
                    map.addLayer(file.clusterGroup);
                }
            });
        }

        function toggleSeleccionMarker(marker) {
            const props = marker.properties;
            const key = props.SUMINISTRO || `${props.LATITUD}_${props.LONGITUD}`;
            const index = selectedMarkers.findIndex(s => (s.SUMINISTRO || `${s.LATITUD}_${s.LONGITUD}`) === key);
            if (index === -1) {
                selectedMarkers.push(props);
                marker.setStyle({fillColor: '#00ff00', radius: 9});
            } else {
                selectedMarkers.splice(index, 1);
                marker.setStyle({fillColor: props.color, radius: 6});
            }
        }

        function cerrarModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        function abrirFiltroVisibilidad() {
            document.getElementById('visA1').checked = visibilidad.A1;
            document.getElementById('visA2').checked = visibilidad.A2;
            document.getElementById('visA3').checked = visibilidad.A3;
            document.getElementById('visIMP').checked = visibilidad.IMPOSIBILIDAD;
            document.getElementById('visProyecto').checked = visibilidad.PROYECTO;
            document.getElementById('visVERENCAMPO').checked = visibilidad.VERENCAMPO;
            document.getElementById('filtroModal').style.display = 'flex';
        }

        function aplicarFiltroVisibilidad() {
            visibilidad.A1 = document.getElementById('visA1').checked;
            visibilidad.A2 = document.getElementById('visA2').checked;
            visibilidad.A3 = document.getElementById('visA3').checked;
            visibilidad.IMPOSIBILIDAD = document.getElementById('visIMP').checked;
            visibilidad.PROYECTO = document.getElementById('visProyecto').checked;
            visibilidad.VERENCAMPO = document.getElementById('visVERENCAMPO').checked;
            cerrarModal('filtroModal');
            aplicarFiltros();
        }

        map.on('zoomend', controlarVistaPorZoom);
        document.getElementById('distritoFilter').addEventListener('change', aplicarFiltros);

    </script>
</body>
</html>
